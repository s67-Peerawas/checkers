import tkinter as tk

class Checkers:
    def __init__(self, master):
        self.master = master
        self.master.title("Checkers")
        self.canvas = tk.Canvas(master, width=640, height=640)
        self.canvas.pack()
        self.board = self.create_board()
        self.current_player = 'white'  # White goes first
        self.selected_piece = None
        self.valid_moves = []
        self.turn_label = tk.Label(master, text=f"Current Turn: {self.current_player}", font=("Arial", 16))
        self.turn_label.pack()

        self.draw_board()
        self.draw_pieces()
        self.canvas.bind("<Button-1>", self.on_click)

    def create_board(self):
        # Create an 8x8 board with pieces in starting positions
        board = [[None for _ in range(8)] for _ in range(8)]
        for row in range(3):
            for col in range((row % 2), 8, 2):
                board[row][col] = 'black'  # Player Black pieces
        for row in range(5, 8):
            for col in range((row % 2), 8, 2):
                board[row][col] = 'white'  # Player White pieces
        return board

    def draw_board(self):
        for row in range(8):
            for col in range(8):
                color = "#D18B47" if (row + col) % 2 == 0 else "#FFCE9E"
                self.canvas.create_rectangle(col * 80, row * 80, (col + 1) * 80, (row + 1) * 80, fill=color)

    def draw_pieces(self):
        self.canvas.delete("pieces")
        for row in range(8):
            for col in range(8):
                piece = self.board[row][col]
                if piece == 'black':
                    self.draw_piece(row, col, "black")
                elif piece == 'white':
                    self.draw_piece(row, col, "white")
                elif piece == 'black_king':
                    self.draw_piece(row, col, "black", is_king=True)
                elif piece == 'white_king':
                    self.draw_piece(row, col, "white", is_king=True)

    def draw_piece(self, row, col, color, is_king=False):
        x_center = col * 80 + 40
        y_center = row * 80 + 40
        self.canvas.create_oval(
            x_center - 30, y_center - 30,
            x_center + 30, y_center + 30,
            fill=color, tags=("pieces", f"{color}_{row}_{col}")
        )
        if is_king:
            self.canvas.create_text(x_center, y_center, text='K', font=("Arial", 24, "bold"), fill="yellow", tags="pieces")

    def on_click(self, event):
        col = event.x // 80
        row = event.y // 80

        if self.selected_piece:
            # Move the piece
            if (row, col) in self.valid_moves:
                self.move_piece(self.selected_piece, (row, col))
                self.selected_piece = None
                self.valid_moves = []
                self.clear_highlight()  # Clear highlights after moving
                self.switch_player()
            else:
                self.selected_piece = None
                self.valid_moves = []
                self.clear_highlight()  # Clear highlights if no valid move
        else:
            # Select a piece
            piece = self.board[row][col]
            if (piece == 'white' and self.current_player == 'white') or (piece == 'black' and self.current_player == 'black'):
                self.selected_piece = (row, col)
                self.valid_moves = self.get_valid_moves(row, col)
                self.highlight_valid_moves()
            elif (piece == 'white_king' and self.current_player == 'white') or (piece == 'black_king' and self.current_player == 'black'):
                self.selected_piece = (row, col)
                self.valid_moves = self.get_valid_moves(row, col)
                self.highlight_valid_moves()

    def get_valid_moves(self, row, col):
        moves = []
        piece_color = self.board[row][col]
        is_king = piece_color.endswith('_king')

        # Determine move direction
        if piece_color.startswith('white'):
            directions = [(-1, -1), (-1, 1)]  # White moves up
        else:
            directions = [(1, -1), (1, 1)]  # Black moves down
        
        if is_king:
            directions.extend([(1, -1), (1, 1), (-1, -1), (-1, 1)])  # Kings can move both directions

        # Normal moves
        for dr, dc in directions:
            new_row, new_col = row + dr, col + dc
            if 0 <= new_row < 8 and 0 <= new_col < 8 and self.board[new_row][new_col] is None:
                moves.append((new_row, new_col))

        # Capture moves
        for dr, dc in directions:
            new_row, new_col = row + dr * 2, col + dc * 2
            mid_row, mid_col = row + dr, col + dc
            if (0 <= new_row < 8 and 0 <= new_col < 8 and
                self.board[new_row][new_col] is None and
                self.board[mid_row][mid_col] is not None and
                self.board[mid_row][mid_col] != piece_color):
                moves.append((new_row, new_col))

        return moves

    def highlight_valid_moves(self):
        # Highlight valid moves with adjusted size to fit the board squares perfectly
        for move in self.valid_moves:
            row, col = move
            x1, y1 = col * 80, row * 80  # Align exactly to the square
            x2, y2 = (col + 1) * 80, (row + 1) * 80  # Align exactly to the square
            self.canvas.create_rectangle(
                x1, y1, x2, y2,
                fill="green", stipple="gray25", outline="",
                tags="highlight"
            )

    def clear_highlight(self):
        # Clear existing highlights
        self.canvas.delete("highlight")

    def move_piece(self, start, end):
        s_row, s_col = start
        e_row, e_col = end
        self.board[e_row][e_col] = self.board[s_row][s_col]  # Move piece
        self.board[s_row][s_col] = None  # Clear start position

        # Capture piece
        if abs(s_row - e_row) == 2:
            mid_row = (s_row + e_row) // 2
            mid_col = (s_col + e_col) // 2
            self.board[mid_row][mid_col] = None  # Remove captured piece

        # Promote to king if piece reaches the last row
        if e_row == 0 and self.board[e_row][e_col] == 'white':
            self.board[e_row][e_col] = 'white_king'
        elif e_row == 7 and self.board[e_row][e_col] == 'black':
            self.board[e_row][e_col] = 'black_king'

        self.draw_pieces()
        self.turn_label.config(text=f"Current Turn: {self.current_player}")

    def switch_player(self):
        self.current_player = 'black' if self.current_player == 'white' else 'white'
        self.turn_label.config(text=f"Current Turn: {self.current_player}")

if __name__ == "__main__":
    root = tk.Tk()
    game = Checkers(root)
    root.mainloop()
